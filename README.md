# nPlayerPro

## Apple Silicon 専用フレームアキュレート・ビデオプレーヤー

---

## ソフトウェア概要

nPlayerPro は、映像制作・ポストプロダクション向けに設計された macOS ネイティブのビデオプレーヤーです。Apple Silicon (arm64) に最適化されており、AVFoundation の低レベル API を直接制御することで、フレーム単位の正確なシーク・再生・検査を実現します。

放送モニターを模したインターフェースにタイムコード表示、リアルタイムオーディオメーター、詳細なメディアメタデータ表示を統合し、映像素材の確認・検証作業を効率化します。

---

## 機能紹介

### フレームアキュレート再生

1フレーム単位の前進・後退操作に対応。キーボードショートカット（←→キー / JKLシャトル）による高速なフレームステップが可能です。デコード済みフレームはリングバッファにキャッシュされ、直前のフレームへの巻き戻しは即座に完了します。

### タイムコード表示

ファイルに埋め込まれたタイムコードトラック（tmcd / tc64）を自動検出し、SMPTE タイムコードとして表示します。ドロップフレーム（29.97fps / 59.94fps）にも対応。タイムコードトラックがない場合は経過時間ベースのカウンター表示に自動切り替えします。

### リアルタイムオーディオメーター

放送グレードの Peak / RMS レベルメーターを搭載。AVAudioEngine の installTap による約93Hzのサンプリングと IIR バリスティックスムージングにより、プロフェッショナルな動きを再現します。クリッピングインジケーター付き。

### マルチオーディオトラック選択

複数のオーディオトラックを持つファイルに対応。ドロップダウンメニューからトラックを切り替えることができ、再生位置を保持したままオーディオエンジンが自動的に再構成されます。5.1ch / 7.1ch サラウンドにも対応。

### ドラッグ＆ドロップ / Finder 統合

ファイルのドラッグ＆ドロップ、⌘O によるファイルオープン、Finder の「このアプリケーションで開く」に対応。Apple Event を SwiftUI の前段で直接インターセプトすることで、GPU レンダリングコンテキストを保護しています。

### メディアメタデータ表示

解像度、フレームレート、コーデック、ビット深度、フィールドドミナンス（プログレッシブ / TFF / BFF）、カラープライマリ、伝達関数、リール名など、映像制作に必要な技術情報をメタデータバーに常時表示します。

---

## 詳細仕様

### 動作環境

| 項目 | 仕様 |
|------|------|
| OS | macOS 26.0 以降 |
| アーキテクチャ | Apple Silicon (arm64) 専用 |
| バンドル ID | dev.nplayerpro.app |
| バージョン | 0.1.0 |

### 対応コンテナフォーマット

| フォーマット | 拡張子 | UTI |
|-------------|--------|-----|
| MPEG-4 | .mp4, .m4v | public.mpeg-4, com.apple.m4v-video |
| QuickTime | .mov | com.apple.quicktime-movie |
| AVI | .avi | public.avi |
| MPEG-2 TS | .ts, .mts, .m2ts | public.mpeg-2-transport-stream |
| Matroska | .mkv | org.matroska.mkv |
| WebM | .webm | org.webmproject.webm |
| MXF | .mxf | org.smpte.mxf |
| MPEG | .mpg, .mpeg | public.mpeg, public.mpeg-2-video |
| 3GPP | .3gp, .3g2 | public.3gpp, public.3gpp2 |

### 対応ビデオコーデック

| コーデック | 識別表示 |
|-----------|---------|
| H.264 / AVC | AVC/H.264 |
| H.265 / HEVC | HEVC/H.265 |
| Apple ProRes 4444 XQ | ProRes 4444 XQ |
| Apple ProRes 4444 | ProRes 4444 |
| Apple ProRes 422 HQ | ProRes 422 HQ |
| Apple ProRes 422 | ProRes 422 |
| Apple ProRes 422 LT | ProRes 422 LT |
| Apple ProRes 422 Proxy | ProRes 422 Proxy |
| MPEG-4 | MPEG-4 |
| MPEG-2 | MPEG-2 |
| Motion JPEG | MJPEG |

※ AVFoundation がデコードをサポートするすべてのコーデックで動作します。上記以外のコーデックは FourCC をそのまま表示します。

### 対応オーディオコーデック

| コーデック | 識別表示 |
|-----------|---------|
| Linear PCM | PCM |
| AAC | AAC |
| AC-3 (Dolby Digital) | AC-3 |
| Enhanced AC-3 (Dolby Digital Plus) | E-AC-3 |
| Apple Lossless | ALAC |
| MP3 | MP3 |

### オーディオメータリング仕様

| パラメータ | 値 |
|-----------|-----|
| メータリング方式 | installTap ベース（リアルタイムオーディオスレッド） |
| スムージング | IIR バリスティックフィルタ |
| アタック時間 | 5 ms |
| リリース時間 | 300 ms |
| ダイナミックレンジ | -60 dBFS 〜 0 dBFS |
| セグメント分割 | 3 dB 間隔 |
| カラースキーム | グリーン（〜-12dB）→ イエロー（-12〜-3dB）→ レッド（-3〜0dB） |
| クリッピング検出 | ピーク ≥ 1.0 で赤色インジケーター表示 |
| 対応チャンネル | Mono / Stereo / 5.1ch / 7.1ch |

一時停止中のフレームステップ操作時は、installTap ではなく CMSampleBuffer から直接ピーク / RMS を算出し、メーターに反映します。

### タイムコードエンジン

| 機能 | 仕様 |
|------|------|
| 対応フォーマット | tmcd（32-bit）/ tc64（64-bit） |
| ドロップフレーム | 29.97fps (2フレームドロップ) / 59.94fps (4フレームドロップ) |
| ノンドロップフレーム | 全フレームレートに対応 |
| フォールバック | タイムコードトラックなし時は経過時間ベース表示 |
| 表示形式 | HH:MM:SS:FF（ノンドロップ）/ HH:MM:SS;FF（ドロップ） |
| インジケーター | TCR（タイムコードリーダー）/ CTR（カウンター） |

### キーボードショートカット

| キー | 機能 |
|------|------|
| ← | 1フレーム戻る |
| → | 1フレーム進む |
| Space | 再生 / 一時停止 |
| J | 1フレーム戻る（JKLシャトル） |
| K | 一時停止（JKLシャトル） |
| L | 1フレーム進む（JKLシャトル） |
| Home | 先頭フレームへ移動 |
| End | 最終フレームへ移動 |
| ⌘O | ファイルを開く |
| ⌘F | フルスクリーン切り替え |
| ⌘0 | ウィンドウサイズ 1280×720 (16:9) |
| ⌘9 | ウィンドウサイズ 720×540 (4:3) |
| ⌘8 | ウィンドウサイズ 720×405 (16:9) |
| ⌘7 | ウィンドウサイズ 1920×1080 (16:9) |

### メタデータバー表示項目

**左カラム：**
- 解像度（幅×高さ）とフィールドドミナンス（P / TFF / BFF）
- フレームレート（Hz）
- デュレーション / 総フレーム数
- リール名

**中央カラム：**
- フレームレート表示（fps）
- 再生状態インジケーター（グリーン: 再生中 / オレンジ: 停止）
- TCR / CTR インジケーター
- SMPTE タイムコード（大型表示）
- フレームカウンター
- トランスポートコントロール（Liquid Glass）

**右カラム：**
- コーデック名 + ビット深度
- オーディオレベルメーター + トラックセレクター
- カラープライマリ
- 伝達関数（Transfer Function）
| 最適化（Release） | -O + Whole Module |
| 外部依存 | なし（純正フレームワークのみ） |
